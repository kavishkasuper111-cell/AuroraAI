<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>AuroraAI | Obsidian Intelligence</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Outfit:wght@600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-database-compat.js"></script>

    <style>
        :root {
            --obsidian: #050505;
            --aurora-1: rgba(16, 185, 129, 0.1);
            --aurora-2: rgba(99, 102, 241, 0.12);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--obsidian);
            color: #f8fafc;
            height: 100dvh;
            margin: 0;
            overflow: hidden;
        }

        /* --- THE AURORA BACKGROUND --- */
        .aurora-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: radial-gradient(circle at 0% 0%, var(--aurora-2) 0%, transparent 50%),
                        radial-gradient(circle at 100% 100%, var(--aurora-1) 0%, transparent 50%);
        }

        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* Responsive Sidebar */
        #sidebar {
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(20px);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100;
        }

        /* Message Styling */
        .user-msg {
            background-color: #262626;
            border-radius: 1.25rem 1.25rem 0.2rem 1.25rem;
            max-width: 85%;
        }

        .ai-msg {
            background-color: transparent;
            width: 100%;
        }

        /* Animation */
        .fade-in { animation: fadeIn 0.4s ease forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .typing-indicator::after {
            content: "┃";
            animation: blink 0.8s infinite;
            color: #10b981;
        }
        @keyframes blink { 50% { opacity: 0; } }

        /* Custom Scrollbar */
        #chat-content::-webkit-scrollbar { width: 4px; }
        #chat-content::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
    </style>
</head>
<body class="flex">

    <div class="aurora-bg"></div>

    <!-- AUTHENTICATION LAYER -->
    <div id="auth-screen" class="fixed inset-0 z-[200] flex items-center justify-center bg-black p-6">
        <div class="glass p-10 rounded-[2.5rem] w-full max-w-md text-center">
            <h1 class="text-4xl font-bold font-outfit mb-2 bg-gradient-to-r from-emerald-400 to-indigo-400 bg-clip-text text-transparent">AuroraAI</h1>
            <p class="text-slate-500 text-sm mb-8">Quantum Access Required</p>
            
            <div class="space-y-4">
                <input type="email" id="email-in" placeholder="Email" class="w-full bg-white/5 border border-white/10 rounded-2xl px-5 py-4 outline-none focus:border-indigo-500 transition">
                <input type="password" id="pass-in" placeholder="Password" class="w-full bg-white/5 border border-white/10 rounded-2xl px-5 py-4 outline-none focus:border-indigo-500 transition">
                <button id="login-btn" class="w-full bg-white text-black font-bold py-4 rounded-2xl hover:bg-slate-200 transition">Login</button>
                <button id="signup-btn" class="w-full text-slate-500 text-xs hover:text-white transition">Create New Identity</button>
            </div>
            <p id="auth-err" class="text-red-400 text-[10px] mt-4"></p>
        </div>
    </div>

    <!-- MAIN APP STRUCTURE -->
    <div id="app-interface" class="hidden flex w-full h-full">
        
        <!-- Sidebar -->
        <aside id="sidebar" class="fixed md:relative inset-y-0 left-0 w-72 transform -translate-x-full md:translate-x-0 flex flex-col border-r border-white/5">
            <div class="p-6">
                <button id="new-chat-btn" class="w-full glass flex items-center justify-center gap-2 p-4 rounded-2xl hover:bg-white/5 transition text-sm font-medium">
                    <i class="fa fa-plus-circle text-emerald-400"></i> New Discovery
                </button>
            </div>
            
            <div id="chat-history" class="flex-grow overflow-y-auto px-4 space-y-2">
                <!-- Saved chats go here -->
            </div>

            <div class="p-6 border-t border-white/5">
                <div class="text-[10px] text-slate-500 uppercase tracking-widest mb-4 px-2" id="user-email-tag"></div>
                <button id="logout-btn" class="flex items-center gap-3 w-full p-2 text-red-400/60 hover:text-red-400 transition text-sm">
                    <i class="fa fa-power-off"></i> Logout
                </button>
            </div>
        </aside>

        <!-- Main Chat View -->
        <main class="flex-grow flex flex-col relative min-w-0">
            <!-- Mobile Header -->
            <header class="md:hidden flex items-center justify-between p-4 border-b border-white/5 glass">
                <button onclick="toggleSidebar()"><i class="fa fa-bars-staggered"></i></button>
                <span class="font-outfit font-bold tracking-tight">AuroraAI</span>
                <button onclick="startNewChat()"><i class="fa fa-edit"></i></button>
            </header>

            <!-- Chat Window -->
            <div id="chat-content" class="flex-grow overflow-y-auto px-4 md:px-20 lg:px-48 py-8 space-y-8 flex flex-col">
                <!-- Welcome View -->
                <div id="welcome-state" class="h-full flex flex-col items-center justify-center text-center">
                    <div class="w-20 h-20 rounded-3xl bg-white/5 flex items-center justify-center mb-6 border border-white/10">
                        <i class="fa fa-shuttle-space text-3xl text-indigo-400"></i>
                    </div>
                    <h2 class="text-3xl font-outfit font-bold mb-2">Initialize AuroraAI</h2>
                    <p class="text-slate-500 max-w-xs text-sm">How can our DeepSeek intelligence assist your discovery today?</p>
                </div>
            </div>

            <!-- Input Composite -->
            <div class="p-4 md:p-8">
                <div class="max-w-4xl mx-auto">
                    <!-- Preview Image -->
                    <div id="preview-container" class="hidden mb-4 animate-fade-in">
                        <div class="relative inline-block">
                            <img id="img-render" src="" class="h-20 w-20 object-cover rounded-2xl border border-white/20">
                            <button onclick="removeImg()" class="absolute -top-2 -right-2 bg-red-500 text-white w-5 h-5 rounded-full text-[10px]">✕</button>
                        </div>
                    </div>

                    <div class="glass rounded-[2rem] p-2 flex items-end gap-2 shadow-2xl">
                        <label class="p-4 cursor-pointer text-slate-500 hover:text-indigo-400 transition">
                            <i class="fa fa-paperclip text-lg"></i>
                            <input type="file" id="attach-file" class="hidden" accept="image/*" onchange="handleFile(event)">
                        </label>
                        
                        <textarea id="main-input" rows="1" placeholder="Ask anything..." 
                            class="w-full bg-transparent border-none focus:ring-0 p-4 outline-none resize-none text-slate-200 placeholder:text-slate-600 max-h-48 h-14"></textarea>
                        
                        <button id="submit-btn" class="bg-white text-black p-4 rounded-full w-12 h-12 flex items-center justify-center hover:scale-105 active:scale-95 transition disabled:opacity-30">
                            <i class="fa fa-arrow-up"></i>
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- CONFIG & INITIALIZATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyBcOXl_7dNkEf9tcDceEg14EgbSBA2lB0I",
            authDomain: "auroraai-1d576.firebaseapp.com",
            databaseURL: "https://auroraai-1d576-default-rtdb.firebaseio.com",
            projectId: "auroraai-1d576",
            storageBucket: "auroraai-1d576.firebasestorage.app",
            messagingSenderId: "85688229672",
            appId: "1:85688229672:web:685bb4df6cce39b3153a1d"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        const OPENROUTER_KEY = "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";
        const MODEL_ID = "nex-agi/deepseek-v3.1-nex-n1:free";

        let activeChatId = Date.now().toString();
        let uploadedBase64 = null;

        // --- AUTHENTICATION ---
        document.getElementById('login-btn').onclick = () => {
            auth.signInWithEmailAndPassword(document.getElementById('email-in').value, document.getElementById('pass-in').value)
                .catch(e => document.getElementById('auth-err').innerText = e.message);
        };
        document.getElementById('signup-btn').onclick = () => {
            auth.createUserWithEmailAndPassword(document.getElementById('email-in').value, document.getElementById('pass-in').value)
                .catch(e => document.getElementById('auth-err').innerText = e.message);
        };
        document.getElementById('logout-btn').onclick = () => auth.signOut();

        auth.onAuthStateChanged(user => {
            if(user) {
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-interface').classList.remove('hidden');
                document.getElementById('user-email-tag').innerText = user.email;
                syncSidebar();
            } else {
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('app-interface').classList.add('hidden');
            }
        });

        // --- IMAGE HANDLING ---
        function handleFile(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (ev) => {
                uploadedBase64 = ev.target.result;
                document.getElementById('img-render').src = uploadedBase64;
                document.getElementById('preview-container').classList.remove('hidden');
            };
            if(file) reader.readAsDataURL(file);
        }

        function removeImg() {
            uploadedBase64 = null;
            document.getElementById('preview-container').classList.add('hidden');
            document.getElementById('attach-file').value = "";
        }

        // --- NEW CHAT LOGIC (THE FIX) ---
        function startNewChat() {
            activeChatId = Date.now().toString(); // New Session ID
            document.getElementById('chat-content').innerHTML = `
                <div id="welcome-state" class="h-full flex flex-col items-center justify-center text-center">
                    <div class="w-20 h-20 rounded-3xl bg-white/5 flex items-center justify-center mb-6 border border-white/10">
                        <i class="fa fa-shuttle-space text-3xl text-indigo-400"></i>
                    </div>
                    <h2 class="text-3xl font-outfit font-bold mb-2">Initialize AuroraAI</h2>
                    <p class="text-slate-500 max-w-xs text-sm">How can our DeepSeek intelligence assist your discovery today?</p>
                </div>`;
            if(window.innerWidth < 768) toggleSidebar(); // Close sidebar on mobile
        }
        document.getElementById('new-chat-btn').onclick = startNewChat;

        // --- CORE COMMUNICATION ---
        async function runAI() {
            const prompt = document.getElementById('main-input').value.trim();
            if(!prompt && !uploadedBase64) return;

            const chatWindow = document.getElementById('chat-content');
            document.getElementById('welcome-state')?.remove();

            // Append User Message
            renderMessage('user', prompt, uploadedBase64);
            const userRef = db.ref(`history/${auth.currentUser.uid}/${activeChatId}`).push();
            userRef.set({ role: 'user', text: prompt, img: uploadedBase64 });

            // Reset Input
            document.getElementById('main-input').value = "";
            removeImg();

            // Create AI Placeholder
            const aiId = 'ai-' + Date.now();
            renderMessage('ai', 'Thinking...', null, aiId);
            const aiBody = document.getElementById(aiId).querySelector('.body-text');
            aiBody.classList.add('typing-indicator');

            try {
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${OPENROUTER_KEY}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        "model": MODEL_ID,
                        "messages": [{ "role": "user", "content": prompt }]
                    })
                });

                const data = await response.json();
                const resultText = data.choices[0].message.content;

                // Finalize AI Message
                aiBody.classList.remove('typing-indicator');
                aiBody.innerText = resultText;
                chatWindow.scrollTop = chatWindow.scrollHeight;

                db.ref(`history/${auth.currentUser.uid}/${activeChatId}`).push({
                    role: 'ai', text: resultText
                });

            } catch (err) {
                aiBody.innerText = "System error: Link interrupted.";
            }
        }

        function renderMessage(role, text, img, id = null) {
            const container = document.getElementById('chat-content');
            const div = document.createElement('div');
            div.className = `flex flex-col fade-in ${role === 'user' ? 'items-end' : 'items-start'}`;
            if(id) div.id = id;

            div.innerHTML = `
                <div class="${role === 'user' ? 'user-msg p-4 text-slate-200' : 'ai-msg py-6 flex gap-4'}">
                    ${role === 'ai' ? `<div class="w-8 h-8 rounded-full bg-indigo-600 flex items-center justify-center text-[10px] shrink-0"><i class="fa fa-bolt"></i></div>` : ''}
                    <div class="flex-grow">
                        ${img ? `<img src="${img}" class="max-w-xs rounded-2xl mb-4 shadow-2xl">` : ''}
                        <div class="body-text text-sm md:text-base leading-relaxed whitespace-pre-wrap">${text}</div>
                    </div>
                </div>
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function syncSidebar() {
            db.ref(`history/${auth.currentUser.uid}`).on('value', snapshot => {
                const list = document.getElementById('chat-history');
                list.innerHTML = "";
                snapshot.forEach(child => {
                    const firstMsg = Object.values(child.val())[0].text || "Visual Task";
                    const item = document.createElement('div');
                    item.className = "p-3 text-xs text-slate-500 truncate hover:bg-white/5 rounded-xl cursor-pointer transition";
                    item.innerText = firstMsg;
                    item.onclick = () => loadExistingChat(child.key);
                    list.prepend(item);
                });
            });
        }

        function loadExistingChat(id) {
            activeChatId = id;
            const chatWindow = document.getElementById('chat-content');
            chatWindow.innerHTML = "";
            db.ref(`history/${auth.currentUser.uid}/${id}`).once('value', snapshot => {
                snapshot.forEach(msg => {
                    const d = msg.val();
                    renderMessage(d.role, d.text, d.img);
                });
            });
            if(window.innerWidth < 768) toggleSidebar();
        }

        // --- UI UTILS ---
        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            sb.classList.toggle('-translate-x-full');
        }

        document.getElementById('submit-btn').onclick = runAI;
        document.getElementById('main-input').onkeydown = (e) => {
            if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); runAI(); }
        };
    </script>
</body>
</html>